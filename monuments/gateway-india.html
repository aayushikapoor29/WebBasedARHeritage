<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taj Mahal - AR Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MODEL-VIEWER: This loads 3D GLB models -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.0.1/model-viewer.min.js"></script>
    <!-- THREE.JS for rendering GLB on canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <style>
        model-viewer {
            width: 100%;
            height: 500px;
            background: linear-gradient(to bottom, #fef3c7, #fde68a);
            border-radius: 16px;
        }
        
        #arOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
        }
        
        #arVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-50 min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Monument Header -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <!-- Monument Info -->
            <div class="bg-gradient-to-r from-orange-100 to-amber-100 p-6">
                <h1 class="text-3xl font-bold text-gray-900">‚õ©Ô∏è Gateway of India</h1>
                <p class="text-lg text-gray-700">üìç Mumbai, India </p>
            </div>

            <!-- 3D MODEL VIEWER - THIS LOADS THE GLB FILE -->
            <div class="p-4">
                <h3 class="text-lg font-semibold mb-2 text-center">üé® 3D Model View</h3>
                <model-viewer
                    id="tajModel"
                    src="../models/gateway-of-india.glb"
                    alt="Gateway of India 3D Model"
                    ar
                    ar-modes="webxr scene-viewer quick-look"
                    camera-controls
                    auto-rotate
                    shadow-intensity="1"
                    environment-image="neutral"
                    style="border: 3px solid #f97316;">
                    
                    <button slot="ar-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold absolute bottom-4 right-4">
                        üì± View in AR
                    </button>
                </model-viewer>
                <p class="text-center text-sm text-gray-600 mt-2">
                    ‚òùÔ∏è Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ On mobile: tap "View in AR"
                </p>
            </div>

            <!-- Monument Information -->
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <span class="text-sm font-semibold text-orange-600">BUILT IN</span>
                        <p class="text-2xl font-bold text-gray-900">1924</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <span class="text-sm font-semibold text-orange-600">PERIOD</span>
                        <p class="text-2xl font-bold text-gray-900">Modern Era</p>
                    </div>
                </div>

                <div class="mb-6">
                    <span class="text-sm font-semibold text-orange-600">üìñ ABOUT</span>
                    <p class="text-gray-700 mt-2 leading-relaxed">
                        The Gateway of India is an iconic monument located in Mumbai, Maharashtra. It was built in 1924 to commemorate the visit of King George V and Queen Mary to India in 1911. The structure is a blend of Hindu and Muslim architectural styles, featuring a large central arch flanked by two smaller arches. Made from yellow basalt and reinforced concrete, the Gateway stands at a height of 26 meters (85 feet) and overlooks the Arabian Sea. It has served as a symbolic entrance to India for visitors arriving by sea and is a popular tourist attraction today.
                    </p>
                </div>

                <div class="mb-6">
                    <span class="text-sm font-semibold text-orange-600">‚ú® ARCHITECTURAL HIGHLIGHTS</span>
                    <ul class="mt-2 space-y-2 text-gray-700">
                        <li>‚Ä¢ Built with yellow basalt and reinforced concrete.</li>
                        <li>‚Ä¢ Features a large central arch flanked by two smaller arches.</li>
                        <li>‚Ä¢ Blends Hindu and Muslim architectural styles.</li>
                        <li>‚Ä¢ Overlooks the Arabian Sea.</li>
                        <li>‚Ä¢ Symbolic entrance to India for visitors arriving by sea.</li>
                    </ul>
                </div>

                <!-- MODULE 3: AUDIO GUIDE -->
                <div class="bg-purple-50 border-2 border-purple-200 p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-semibold text-purple-900">üîä AUDIO GUIDE</span>
                            <p class="text-sm text-purple-700">Listen to detailed history</p>
                        </div>
                        <button id="audioBtn" onclick="toggleAudio()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition-all">
                            ‚ñ∂Ô∏è Play Audio
                        </button>
                    </div>
                </div>

                <!-- MODULE 1: AR CAMERA OVERLAY -->
                <div class="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-semibold text-blue-900">üì∏ AR OVERLAY MODE</span>
                            <p class="text-sm text-blue-700">See 3D model overlaid on camera</p>
                        </div>
                        <button onclick="startAROverlay()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-all">
                            üéØ Start AR
                        </button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="flex gap-3">
                    <button onclick="window.location.href='../index.html'" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        ‚Üê Back to Scanner
                    </button>
                    <button onclick="shareMonument()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Share üì§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE 1 & 4: AR OVERLAY WITH GLB MODEL -->
    <div id="arOverlay" class="hidden">
        <video id="arVideo" autoplay playsinline></video>
        <canvas id="arCanvas"></canvas>
        
        <!-- AR Controls -->
        <div class="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
            <div class="bg-black bg-opacity-70 text-white px-4 py-2 rounded-lg">
                <p class="font-semibold">‚õ©Ô∏è Gateway of India</p>
                <p class="text-sm">AR Mode - Position yourself in frame</p>
            </div>
            <button onclick="stopAROverlay()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                ‚ùå Close
            </button>
        </div>

        <!-- Bottom Controls -->
        <div class="absolute bottom-4 left-4 right-4 z-10">
            <div class="bg-black bg-opacity-70 p-4 rounded-lg">
                <div class="flex justify-around items-center">
                    <button onclick="rotateModel(-15)" class="text-white flex flex-col items-center">
                        <span class="text-2xl">‚Ü∫</span>
                        <span class="text-xs">Rotate Left</span>
                    </button>
                    <button onclick="scaleModel(-0.1)" class="text-white flex flex-col items-center">
                        <span class="text-2xl">‚àí</span>
                        <span class="text-xs">Smaller</span>
                    </button>
                    
                    <!-- MODULE 4: PHOTO CAPTURE -->
                    <button onclick="capturePhoto()" class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-8 rounded-full text-3xl">
                        üì∑
                    </button>
                    
                    <button onclick="scaleModel(0.1)" class="text-white flex flex-col items-center">
                        <span class="text-2xl">+</span>
                        <span class="text-xs">Bigger</span>
                    </button>
                    <button onclick="rotateModel(15)" class="text-white flex flex-col items-center">
                        <span class="text-2xl">‚Üª</span>
                        <span class="text-xs">Rotate Right</span>
                    </button>
                </div>
                <div class="mt-3 flex gap-2">
                    <button onclick="moveModel(0, -20)" class="flex-1 bg-gray-700 text-white py-2 rounded">‚¨ÜÔ∏è Up</button>
                    <button onclick="moveModel(0, 20)" class="flex-1 bg-gray-700 text-white py-2 rounded">‚¨áÔ∏è Down</button>
                    <button onclick="moveModel(-20, 0)" class="flex-1 bg-gray-700 text-white py-2 rounded">‚¨ÖÔ∏è Left</button>
                    <button onclick="moveModel(20, 0)" class="flex-1 bg-gray-700 text-white py-2 rounded">‚û°Ô∏è Right</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Preview Modal -->
    <div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full p-6">
            <h3 class="text-2xl font-bold mb-4 text-center">üì∏ Photo Captured!</h3>
            <img id="capturedPhoto" class="w-full rounded-lg mb-4" />
            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadPhoto()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                    ‚¨áÔ∏è Download
                </button>
                <button onclick="sharePhoto()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                    üì§ Share
                </button>
            </div>
            <button onclick="closePhotoModal()" class="w-full mt-3 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold">
                Take Another Photo
            </button>
        </div>
    </div>

    <script>
        // MODULE 3: AUDIO GUIDE (Text-to-Speech)
        let isPlaying = false;
            const audioScript = " The Gateway of India is an iconic monument located in Mumbai, Maharashtra. It was built in 1924 to commemorate the visit of King George V and Queen Mary to India in 1911. The structure is a blend of Hindu and Muslim architectural styles, featuring a large central arch flanked by two smaller arches. Made from yellow basalt and reinforced concrete, the Gateway stands at a height of 26 meters (85 feet) and overlooks the Arabian Sea. It has served as a symbolic entrance to India for visitors arriving by sea and is a popular tourist attraction today.";

        function toggleAudio() {
            const btn = document.getElementById('audioBtn');
            
            if (isPlaying) {
                window.speechSynthesis.cancel();
                btn.innerHTML = '‚ñ∂Ô∏è Play Audio';
                isPlaying = false;
            } else {
                const utterance = new SpeechSynthesisUtterance(audioScript);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.onend = () => {
                    btn.innerHTML = '‚ñ∂Ô∏è Play Audio';
                    isPlaying = false;
                };
                window.speechSynthesis.speak(utterance);
                btn.innerHTML = '‚è∏Ô∏è Pause Audio';
                isPlaying = true;
            }
        }

        // MODULE 1 & 4: AR OVERLAY WITH THREE.JS GLB RENDERING
        let arStream = null;
        let arCanvas, arCtx, arVideo;
        let scene, camera, renderer, glbModel;
        let rotation = 0;
        let scale = 1;
        let posX = 0;
        let posY = 0;
        let animationId;
        let modelLoaded = false;

        async function startAROverlay() {
            try {
                arStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                document.getElementById('arOverlay').classList.remove('hidden');
                arVideo = document.getElementById('arVideo');
                arCanvas = document.getElementById('arCanvas');
                arCtx = arCanvas.getContext('2d');
                
                arVideo.srcObject = arStream;
                arVideo.play();
                
                arVideo.onloadedmetadata = () => {
                    arCanvas.width = arVideo.videoWidth;
                    arCanvas.height = arVideo.videoHeight;
                    initThreeJS();
                    loadGLBModel();
                    drawAROverlay();
                };
            } catch (err) {
                alert('Camera access denied. Please enable camera permissions.');
                console.error(err);
            }
        }

        function initThreeJS() {
            // Create Three.js scene
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(75, arCanvas.width / arCanvas.height, 0.1, 1000);
            camera.position.z = 5;
            
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(arCanvas.width, arCanvas.height);
            renderer.setClearColor(0x000000, 0);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
        }

        function loadGLBModel() {
            const loader = new THREE.GLTFLoader();
            
            loader.load(
                '../models/gateway-of-india.glb',
                function(gltf) {
                    glbModel = gltf.scene;
                    
                    // Center and scale the model
                    const box = new THREE.Box3().setFromObject(glbModel);
                    const center = box.getCenter(new THREE.Vector3());
                    glbModel.position.sub(center);
                    
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scaleVal = 3 / maxDim;
                    glbModel.scale.set(scaleVal, scaleVal, scaleVal);
                    
                    scene.add(glbModel);
                    modelLoaded = true;
                    console.log('GLB model loaded successfully');
                },
                function(xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Error loading GLB model:', error);
                    alert('Could not load 3D model. Please check the file path.');
                }
            );
        }

        function drawAROverlay() {
            if (!arStream) return;
            
            arCtx.clearRect(0, 0, arCanvas.width, arCanvas.height);
            
            // Render 3D model if loaded
            if (modelLoaded && glbModel) {
                // Apply transformations
                glbModel.rotation.y = (rotation * Math.PI) / 180;
                glbModel.scale.set(scale, scale, scale);
                glbModel.position.x = posX / 100;
                glbModel.position.y = -posY / 100;
                
                // Render to canvas
                renderer.render(scene, camera);
                
                // Draw the rendered image on the canvas
                arCtx.drawImage(renderer.domElement, 0, 0);
            } else {
                // Show loading message
                arCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                arCtx.font = 'bold 24px Arial';
                arCtx.textAlign = 'center';
                arCtx.fillText('Loading 3D Model...', arCanvas.width / 2, arCanvas.height / 2);
            }
            
            animationId = requestAnimationFrame(drawAROverlay);
        }

        function rotateModel(angle) {
            rotation += angle;
        }

        function scaleModel(delta) {
            scale = Math.max(0.3, Math.min(3, scale + delta));
        }

        function moveModel(deltaX, deltaY) {
            posX += deltaX;
            posY += deltaY;
        }

        function stopAROverlay() {
            if (arStream) {
                arStream.getTracks().forEach(track => track.stop());
                arStream = null;
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            document.getElementById('arOverlay').classList.add('hidden');
            rotation = 0;
            scale = 1;
            posX = 0;
            posY = 0;
            modelLoaded = false;
            
            // Clean up Three.js
            if (renderer) {
                renderer.dispose();
                renderer = null;
            }
            if (scene) {
                scene.clear();
                scene = null;
            }
        }

        // MODULE 4: PHOTO CAPTURE - Combines camera feed + 3D GLB model
        let capturedPhotoData = null;

        function capturePhoto() {
            const photoCanvas = document.createElement('canvas');
            photoCanvas.width = arCanvas.width;
            photoCanvas.height = arCanvas.height;
            const photoCtx = photoCanvas.getContext('2d');
            
            // 1. Draw video frame (you in the camera)
            photoCtx.drawImage(arVideo, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // 2. Draw the 3D model overlay on top
            if (modelLoaded && renderer) {
                photoCtx.drawImage(renderer.domElement, 0, 0);
            }
            
            // 3. Add watermark
            photoCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            photoCtx.fillRect(0, photoCanvas.height - 80, photoCanvas.width, 80);
            photoCtx.fillStyle = 'white';
            photoCtx.font = 'bold 32px Arial';
            photoCtx.fillText('üïå Qutub Minar AR', 30, photoCanvas.height - 40);
            photoCtx.font = '20px Arial';
            photoCtx.fillText(new Date().toLocaleDateString(), 30, photoCanvas.height - 15);
            
            capturedPhotoData = photoCanvas.toDataURL('image/png');
            document.getElementById('capturedPhoto').src = capturedPhotoData;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function downloadPhoto() {
            const link = document.createElement('a');
            link.download = `qutub-minar-ar-${Date.now()}.png`;
            link.href = capturedPhotoData;
            link.click();
        }

        function sharePhoto() {
            if (navigator.share) {
                fetch(capturedPhotoData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'qutub-minar-ar.png', { type: 'image/png' });
                        navigator.share({
                            title: 'Qutub Minar AR Experience',
                            text: 'Check out my AR photo with Qutub Minar!',
                            files: [file]
                        });
                    });
            } else {
                alert('Share feature not supported on this device.');
            }
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // Share monument
        function shareMonument() {
            if (navigator.share) {
                navigator.share({
                    title: 'Qutub Minar AR Experience',
                    text: 'Explore the Qutub Minar in AR!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            stopAROverlay();
            if (isPlaying) window.speechSynthesis.cancel();
        });
    </script>
</body>
</html>